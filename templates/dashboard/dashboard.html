{% extends "base.html" %}

{% block title %}Dashboard - BENJ INSIDE{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Welcome Section -->
    <div class="bg-gradient-to-r from-primary-600 to-primary-800 text-white rounded-xl shadow-lg p-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">
                    Bienvenue, {{ user.username }}!
                </h1>
                <p class="text-primary-100">
                    Que la paix de Dieu soit avec vous aujourd'hui
                </p>
                <div class="mt-4 text-sm opacity-90">
                    <span class="bg-primary-500 px-3 py-1 rounded-full">
                        Rôle: {{ user.role.title() }}
                    </span>
                    {% if user.departement %}
                    <span class="bg-primary-500 px-3 py-1 rounded-full ml-2">
                        Département: {{ user.departement.nom }}
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="hidden md:block">
                <i class="fas fa-hands-praying text-6xl opacity-20"></i>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <a href="{{ url_for('dashboard.profile') }}" class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 text-center">
            <div class="bg-blue-100 dark:bg-blue-900 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-user text-blue-600 text-xl"></i>
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-white">Mon Profil</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Modifier mes informations</p>
        </a>

        <a href="{{ url_for('dashboard.testimonials') }}" class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 text-center">
            <div class="bg-purple-100 dark:bg-purple-900 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-heart text-purple-600 text-xl"></i>
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-white">Témoignages</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Partager ma foi</p>
        </a>

        <a href="{{ url_for('dashboard.playlist') }}" class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 text-center">
            <div class="bg-orange-100 dark:bg-orange-900 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-music text-orange-600 text-xl"></i>
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-white">Playlist</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Écouter les enseignements</p>
        </a>

        <a href="{{ url_for('dashboard.chatbot') }}" class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 text-center">
            <div class="w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <img src="{{ url_for('static', filename='images/kadosh_logo.png') }}" alt="Kadosh.ia Logo" class="w-12 h-12 rounded-full object-contain">
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-white">Kadosh.ia</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Assistant biblique</p>
        </a>
        
        {% if current_user.role in ['ouvrier', 'chef', 'admin'] %}
        <a href="{{ url_for('announcements.announcements') }}" class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 text-center">
            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-bullhorn text-blue-600 text-xl"></i>
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-white">Annonces</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Créer des annonces</p>
        </a>
        {% endif %}
        
        {% if current_user.role == 'membre' %}
        <a href="{{ url_for('department_requests.department_candidatures') }}" class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 text-center">
            <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-building text-green-600 text-xl"></i>
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-white">Candidatures</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Postuler aux départements</p>
        </a>
        {% endif %}
        
        {% if current_user.role == 'admin' and pending_requests_count > 0 %}
        <a href="{{ url_for('department_requests.admin_department_requests') }}" class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow p-6 text-center relative">
            <div class="bg-red-100 dark:bg-red-900 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-white">Candidatures à traiter</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ pending_requests_count }} demande(s) en attente</p>
            <div class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">
                {{ pending_requests_count }}
            </div>
        </a>
        {% endif %}
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Daily Verse -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-book-open text-primary-600 mr-2"></i>
                Verset du jour
            </h2>
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                <blockquote class="text-gray-700 dark:text-gray-300 italic mb-2">
                    "{{ daily_verse.text }}"
                </blockquote>
                <cite class="text-primary-600 font-semibold">{{ daily_verse.reference }}</cite>
            </div>
        </div>

        <!-- Recent Announcements -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-bullhorn text-primary-600 mr-2"></i>
                Annonces récentes
            </h2>
            <div class="space-y-4">
                {% for announcement in announcements %}
                <div class="border-l-4 border-primary-500 pl-4 py-2">
                    <h3 class="font-semibold text-gray-900 dark:text-white">{{ announcement.titre }}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ announcement.description }}</p>
                    <div class="text-xs text-gray-500 dark:text-gray-500 mt-2">
                        <span><i class="fas fa-calendar mr-1"></i>{{ announcement.date_programme.strftime('%d/%m/%Y') }}</span>
                        <span class="ml-3"><i class="fas fa-clock mr-1"></i>{{ announcement.heure_programme.strftime('%H:%M') }}</span>
                        {% if announcement.lieu %}<span class="ml-3"><i class="fas fa-map-marker-alt mr-1"></i>{{ announcement.lieu }}</span>{% endif %}
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 dark:text-gray-400 text-center py-4">Aucune annonce récente</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Admin: Candidatures en attente -->
        {% if current_user.role == 'admin' and pending_requests_count > 0 %}
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border-l-4 border-orange-500">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-user-clock text-orange-600 mr-2"></i>
                Candidatures en attente
                <span class="ml-2 bg-orange-100 text-orange-800 text-sm font-medium px-2.5 py-0.5 rounded-full">
                    {{ pending_requests_count }}
                </span>
            </h2>
            <div class="space-y-3">
                {% for request in pending_requests %}
                <div class="flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-orange-100 dark:bg-orange-800 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-orange-600 text-sm"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-white">{{ request.user.username }}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">{{ request.department.nom }} - {{ request.role_requested }}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <a href="{{ url_for('department_requests.admin_department_requests') }}" 
                           class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded transition-colors" 
                           title="Voir détails">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-4 text-center">
                <a href="{{ url_for('department_requests.admin_department_requests') }}" 
                   class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-cog mr-2"></i>
                    Gérer toutes les candidatures
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Financial Status -->
    {% if finances %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center">
                <i class="fas fa-dollar-sign text-green-600 mr-2"></i>
                Mes obligations financières
            </h2>
            <a href="{{ url_for('finances.finances') }}" 
               class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                <i class="fas fa-eye mr-2"></i>
                Voir tout
            </a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 py-2 text-left text-gray-900 dark:text-white">Type</th>
                        <th class="px-4 py-2 text-left text-gray-900 dark:text-white">Montant</th>
                        <th class="px-4 py-2 text-left text-gray-900 dark:text-white">Échéance</th>
                        <th class="px-4 py-2 text-left text-gray-900 dark:text-white">Statut</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                    {% for finance in finances %}
                    <tr>
                        <td class="px-4 py-2 text-gray-900 dark:text-white">{{ finance.type.title() }}</td>
                        <td class="px-4 py-2 text-gray-900 dark:text-white">{{ finance.montant }} FCFA</td>
                        <td class="px-4 py-2 text-gray-900 dark:text-white">
                            {% if finance.deadline %}
                                {{ finance.deadline.strftime('%d/%m/%Y') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-4 py-2">
                            <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                                Non payé
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Role-specific sections -->
    {% if user.role == 'ouvrier' and user.score > 0 %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-star text-yellow-500 mr-2"></i>
            Mon score
        </h2>
        <div class="flex items-center">
            <div class="bg-yellow-100 dark:bg-yellow-900 rounded-full w-16 h-16 flex items-center justify-center mr-4">
                <span class="text-2xl font-bold text-yellow-700 dark:text-yellow-300">{{ user.score }}</span>
            </div>
            <div>
                <p class="text-gray-700 dark:text-gray-300">Score attribué par votre chef de département</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">Sur 20 points</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Admin/Chef Quick Links -->
    {% if user.role in ['admin', 'chef'] %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
            <i class="fas fa-cogs text-gray-600 mr-2"></i>
            Gestion
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {% if user.role == 'admin' %}
            <a href="{{ url_for('admin.members') }}" class="bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-lg p-4 text-center transition-colors">
                <i class="fas fa-users text-blue-600 text-2xl mb-2"></i>
                <p class="text-sm font-medium text-blue-800 dark:text-blue-200">Gestion des membres</p>
            </a>
            <a href="{{ url_for('admin.finances') }}" class="bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30 rounded-lg p-4 text-center transition-colors">
                <i class="fas fa-dollar-sign text-green-600 text-2xl mb-2"></i>
                <p class="text-sm font-medium text-green-800 dark:text-green-200">Gestion financière</p>
            </a>
            <a href="{{ url_for('admin.testimonials_admin') }}" class="bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-900/30 rounded-lg p-4 text-center transition-colors">
                <i class="fas fa-heart text-purple-600 text-2xl mb-2"></i>
                <p class="text-sm font-medium text-purple-800 dark:text-purple-200">Modération témoignages</p>
            </a>
            <a href="{{ url_for('admin.playlist_admin') }}" class="bg-orange-50 dark:bg-orange-900/20 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg p-4 text-center transition-colors">
                <i class="fas fa-music text-orange-600 text-2xl mb-2"></i>
                <p class="text-sm font-medium text-orange-800 dark:text-orange-200">Gestion Playlist</p>
            </a>
            {% endif %}
            {% if user.role == 'chef' %}
            <a href="{{ url_for('chef.workers') }}" class="bg-orange-50 dark:bg-orange-900/20 hover:bg-orange-100 dark:hover:bg-orange-900/30 rounded-lg p-4 text-center transition-colors">
                <i class="fas fa-users text-orange-600 text-2xl mb-2"></i>
                <p class="text-sm font-medium text-orange-800 dark:text-orange-200">Mes ouvriers</p>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Admin Playlist Management -->
    {% if user.role == 'admin' and playlist_items %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white flex items-center">
                <i class="fas fa-music text-orange-600 mr-2"></i>
                Gestion Playlist Audio
            </h2>
            <div class="flex space-x-2">
                <button onclick="openAddAudioModal()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                    <i class="fas fa-plus mr-1"></i>
                    Ajouter
                </button>
                <button onclick="testSystemAudio()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                    <i class="fas fa-volume-up mr-1"></i>
                    Test Son
                </button>
                <a href="{{ url_for('admin.playlist_admin') }}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                    <i class="fas fa-cog mr-1"></i>
                    Gérer
                </a>
            </div>
        </div>
        
        <div class="space-y-3">
            {% for item in playlist_items %}
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-orange-100 dark:bg-orange-900 rounded-full flex items-center justify-center">
                        {% if item.is_local %}
                        <i class="fas fa-file-audio text-orange-600 text-sm"></i>
                        {% else %}
                        <i class="fas fa-link text-orange-600 text-sm"></i>
                        {% endif %}
                    </div>
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-white">{{ item.titre }}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            {% if item.description %}{{ item.description[:50] }}...{% endif %}
                        </p>
                        <div class="flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400">
                            <span>Volume: {{ (item.volume * 100)|round|int }}%</span>
                            <span>•</span>
                            <span>{{ item.date_ajout.strftime('%d/%m/%Y') }}</span>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="playPersistentAudio('{{ item.fichier_audio_url }}', '{{ item.titre }}', '{{ item.description or '' }}', {{ item.volume }})" 
                            class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm transition-colors">
                        <i class="fas fa-play mr-1"></i>
                        Écouter
                    </button>
                    <button onclick="deleteAudio({{ item.id }}, '{{ item.titre }}')" 
                            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                        <i class="fas fa-trash mr-1"></i>
                        Suppr
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Audio Modal -->
<div id="add-audio-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white">Ajouter un Audio</h3>
                    <button onclick="closeAddAudioModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form method="POST" action="{{ url_for('admin.add_playlist_item') }}" enctype="multipart/form-data" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Titre de l'audio
                        </label>
                        <input type="text" name="titre" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Description (optionnel)
                        </label>
                        <textarea name="description" rows="2" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Source de l'audio
                        </label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="source_type" value="local" checked class="text-orange-600">
                                <span class="ml-2 text-sm">Fichier local (recommandé)</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="source_type" value="url" class="text-orange-600">
                                <span class="ml-2 text-sm">URL externe</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="file-upload-section">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Fichier audio
                        </label>
                        <input type="file" name="audio_file" accept=".mp3,.wav,.ogg" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <p class="text-xs text-gray-500 mt-1">Formats supportés: MP3, WAV, OGG (max 50MB)</p>
                    </div>
                    
                    <div id="url-input-section" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            URL de l'audio
                        </label>
                        <input type="url" name="audio_url" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Volume par défaut
                        </label>
                        <input type="range" name="volume" min="0" max="1" step="0.1" value="0.7" 
                               class="w-full" oninput="updateVolumeDisplay(this.value)">
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>0%</span>
                            <span id="volume-display">70%</span>
                            <span>100%</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeAddAudioModal()" 
                                class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            Annuler
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors">
                            Valider
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function openAddAudioModal() {
    document.getElementById('add-audio-modal').classList.remove('hidden');
}

function closeAddAudioModal() {
    document.getElementById('add-audio-modal').classList.add('hidden');
}

function updateVolumeDisplay(value) {
    const percentage = Math.round(value * 100);
    document.getElementById('volume-display').textContent = percentage + '%';
}

// Function to test system audio
function testSystemAudio() {
    // Create a simple beep sound using Web Audio API
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800; // 800 Hz beep
    gainNode.gain.value = 0.3; // 30% volume
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.5); // Play for 0.5 seconds
    
    alert('Si vous avez entendu un bip, l\'audio fonctionne. Sinon, vérifiez le volume de votre système.');
}

// Function to test audio with enhanced debugging
function testAudio(url, title, description, volume) {
    console.log('Test audio called with:', { url, title, description, volume });
    
    // Create a simple audio test first
    const testAudio = new Audio();
    testAudio.volume = Math.min(1.0, volume * 0.8); // Set volume to 80% of admin setting
    testAudio.src = url;
    testAudio.preload = 'auto';
    
    testAudio.addEventListener('loadeddata', () => {
        console.log('Audio loaded successfully');
        testAudio.play().then(() => {
            console.log('Audio test playback started');
            // Show notification
            if (window.showNotification) {
                window.showNotification(`Test audio: ${title}`, 'success');
            }
        }).catch(error => {
            console.error('Audio test failed:', error);
            alert(`Erreur test audio: ${error.message}\nVérifiez votre volume système et réessayez.`);
        });
    });
    
    testAudio.addEventListener('error', (e) => {
        console.error('Audio test error:', e);
        alert('Erreur: impossible de charger le fichier audio\nVérifiez que le fichier existe et est accessible.');
    });
    
    testAudio.addEventListener('canplaythrough', () => {
        console.log('Audio ready to play through');
    });
    
    // Use the main audio player as fallback
    if (window.playAudio) {
        window.playAudio(url, title, description, volume);
    }
}

// Function to delete audio
function deleteAudio(audioId, audioTitle) {
    if (confirm(`Êtes-vous sûr de vouloir supprimer "${audioTitle}" ?`)) {
        fetch(`/admin/playlist/delete/${audioId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erreur lors de la suppression');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la suppression');
        });
    }
}

// Toggle between file upload and URL input
document.addEventListener('DOMContentLoaded', function() {
    const sourceRadios = document.querySelectorAll('input[name="source_type"]');
    const fileSection = document.getElementById('file-upload-section');
    const urlSection = document.getElementById('url-input-section');
    
    if (sourceRadios.length > 0) {
        sourceRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'local') {
                    fileSection.classList.remove('hidden');
                    urlSection.classList.add('hidden');
                    document.querySelector('input[name="audio_file"]').required = true;
                    document.querySelector('input[name="audio_url"]').required = false;
                } else {
                    fileSection.classList.add('hidden');
                    urlSection.classList.remove('hidden');
                    document.querySelector('input[name="audio_file"]').required = false;
                    document.querySelector('input[name="audio_url"]').required = true;
                }
            });
        });
    }
});
</script>

{% endblock %}

<!-- Audio Player Interface -->
<div id="current-player" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 shadow-lg hidden z-40">
    <div class="max-w-4xl mx-auto">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <button id="play-pause-btn" class="bg-orange-600 hover:bg-orange-700 text-white p-2 rounded-full transition-colors">
                        <i class="fas fa-play"></i>
                    </button>
                    <button id="stop-btn" class="bg-gray-600 hover:bg-gray-700 text-white p-2 rounded-full transition-colors">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
                <div class="flex-1 min-w-0">
                    <h4 id="current-title" class="text-sm font-medium text-gray-900 dark:text-white truncate">-</h4>
                    <p id="current-description" class="text-xs text-gray-500 dark:text-gray-400 truncate">-</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4 flex-1 max-w-md">
                <div class="flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400">
                    <span id="current-time">0:00</span>
                    <input type="range" id="progress-bar" min="0" max="100" value="0" 
                           class="flex-1 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="duration">0:00</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-volume-down text-gray-500 dark:text-gray-400"></i>
                    <input type="range" id="volume-control" min="0" max="100" value="80" 
                           class="w-20 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </div>
    </div>
</div>

<audio id="audio-player" preload="none"></audio>

{% block scripts %}
<script src="{{ url_for('static', filename='js/audio-player.js') }}"></script>
{% endblock %}
